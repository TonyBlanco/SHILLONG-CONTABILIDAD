# -*- coding: utf-8 -*-
"""
RegistrarView — SHILLONG CONTABILIDAD v3 PRO (versión OPTIMIZADA 150% DPI)
"""

from models.CuentasMotor import MotorCuentas

from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QFormLayout, QLineEdit, QDateEdit,
    QComboBox, QPushButton, QLabel, QTableWidget, QTableWidgetItem,
    QMessageBox, QCompleter, QHeaderView, QAbstractItemView, QApplication,
    QGroupBox, QRadioButton, QButtonGroup
)
from PySide6.QtCore import Qt, QDate
from PySide6.QtGui import QColor
import random
from datetime import datetime


class RegistrarView(QWidget):

    def __init__(self, data):
        super().__init__()
        self.data = data
        self.motor = MotorCuentas()
        self.tema_oscuro = False

        QApplication.setStyle("windows")
        self.setStyleSheet(self._estilo_claro())

        self._build_ui()
        self._cargar_ultimos()

    # ============================================================
    # ESTILOS
    # ============================================================
    def _estilo_claro(self):
        return """
            QWidget { background: #f8fafc; font-family: 'Segoe UI'; }
            QLabel { color: #1e293b; font-size: 14px; font-weight: 600; }
            QLineEdit, QDateEdit, QComboBox {
                padding: 10px 14px; 
                border: 2px solid #e2e8f0; 
                border-radius: 8px;
                font-size: 15px; 
                background: white;
                min-height: 36px;
            }
            QLineEdit:focus, QComboBox:focus { border-color: #3b82f6; }
            QPushButton {
                padding: 9px 20px; 
                border-radius: 10px; 
                font-weight: bold; 
                font-size: 13px;
                color: white;
                min-height: 32px;
            }
            QPushButton#guardar { background: #2563eb; }
            QPushButton#refresh { background: #64748b; }
            QPushButton#duplicar { background: #7c3aed; }
            QPushButton#tema { background: #475569; }
            QPushButton#actualizar { background: #475569; }
            QPushButton#limpiar { background: #0ea5e9; }
            QPushButton#limpiar_dh { background: #64748b; }
            QPushButton#nuevo { background: #16a34a; }
            QHeaderView::section { background: #e0e7ff; padding: 10px; font-weight: bold; }
            QGroupBox {
                font-weight: bold; border: 2px solid #cbd5e1; border-radius: 12px;
                margin-top: 10px; padding-top: 10px;
            }
        """

    def _estilo_oscuro(self):
        return """
            QWidget { background: #0f172a; color: #e2e8f0; }
            QLabel { color: #e2e8f0; }
            QLineEdit, QDateEdit, QComboBox {
                background: #1e293b; color: #e2e8f0; border: 2px solid #334155;
                padding: 12px 16px; border-radius: 8px;
            }
            QPushButton#guardar { background: #3b82f6; }
            QPushButton#refresh { background: #64748b; }
            QPushButton#duplicar { background: #8b5cf6; }
            QPushButton#tema { background: #475569; }
            QPushButton#limpiar { background: #0ea5e9; }
            QPushButton#limpiar_dh { background: #6b7280; }
            QPushButton#nuevo { background: #059669; }
            QHeaderView::section { background: #334155; color: white; }
        """

    def _cambiar_tema(self):
        self.tema_oscuro = not self.tema_oscuro
        self.setStyleSheet(self._estilo_oscuro() if self.tema_oscuro else self._estilo_claro())
        self.btn_tema.setText("Modo claro" if self.tema_oscuro else "Modo oscuro")

    # ============================================================
    # UI PRINCIPAL
    # ============================================================
    def _build_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(30, 20, 30, 20)
        layout.setSpacing(20)

        # Título + Botón tema
        top = QHBoxLayout()
        titulo = QLabel("REGISTRAR MOVIMIENTO CONTABLE")
        titulo.setStyleSheet("font-size: 26px; font-weight: 800; color: #1e293b;")
        titulo.setAlignment(Qt.AlignCenter)
        self.btn_tema = QPushButton("Modo oscuro")
        self.btn_tema.setObjectName("tema")
        self.btn_tema.clicked.connect(self._cambiar_tema)
        top.addWidget(titulo)
        top.addStretch()
        top.addWidget(self.btn_tema)
        layout.addLayout(top)

        # Formulario
        form = QGroupBox()
        form_layout = QFormLayout(form)
        form_layout.setLabelAlignment(Qt.AlignRight)
        form_layout.setHorizontalSpacing(20)
        form_layout.setVerticalSpacing(16)

        # Fecha
        self.fecha = QDateEdit()
        self.fecha.setCalendarPopup(True)
        self.fecha.setDate(QDate.currentDate())
        self.fecha.setDisplayFormat("dd/MM/yyyy")
        form_layout.addRow("Fecha:", self.fecha)

        # Documento
        self.documento = QLineEdit()
        self.documento.setPlaceholderText("Opcional — si está vacío se genera automático")
        form_layout.addRow("Documento:", self.documento)

        # Cuenta contable
        self.cuenta_combo = QComboBox()
        self.cuenta_combo.setEditable(True)
        opciones = self.motor.todas_las_opciones()
        self.cuenta_combo.addItems(opciones)
        completer = QCompleter(opciones, self)
        completer.setFilterMode(Qt.MatchContains)
        completer.setCaseSensitivity(Qt.CaseInsensitive)
        self.cuenta_combo.setCompleter(completer)
        self.cuenta_combo.currentTextChanged.connect(self._on_cuenta_changed)
        form_layout.addRow("Cuenta contable:", self.cuenta_combo)

        # Nombre cuenta
        self.lbl_nombre = QLabel("Seleccione una cuenta")
        self.lbl_nombre.setStyleSheet("font-style:italic;color:#64748b;")
        form_layout.addRow("", self.lbl_nombre)

        # Sugerencias
        self.lbl_sugerencias = QLabel("")
        self.lbl_sugerencias.setStyleSheet("color:#6366f1;font-size:13px;")
        self.lbl_sugerencias.setWordWrap(True)
        form_layout.addRow("", self.lbl_sugerencias)

        # Concepto
        self.concepto = QLineEdit()
        self.concepto.setPlaceholderText("Descripción del movimiento…")
        self.concepto.textChanged.connect(self._validar_concepto_live)
        form_layout.addRow("Concepto:", self.concepto)

        # Importe Debe / Haber
        row_dh = QHBoxLayout()
        self.debe = QLineEdit("0,00")
        self.haber = QLineEdit("0,00")
        self.debe.setAlignment(Qt.AlignRight)
        self.haber.setAlignment(Qt.AlignRight)
        self.debe.textChanged.connect(self._calcular_importe)
        self.haber.textChanged.connect(self._calcular_importe)
        row_dh.addWidget(QLabel("Debe:"))
        row_dh.addWidget(self.debe)
        row_dh.addWidget(QLabel("Haber:"))
        row_dh.addWidget(self.haber)
        form_layout.addRow("Importe:", row_dh)

        # BANCO + ESTADO EN UNA SOLA LÍNEA (CHIP STYLE)
        fila_banco_estado = QHBoxLayout()
        fila_banco_estado.setSpacing(30)
        fila_banco_estado.addStretch()

        # Grupo Banco
        self.banco_buttons = QButtonGroup(self)
        self.banco_buttons.setExclusive(True)
        banco_layout = QHBoxLayout()
        banco_layout.setSpacing(8)

        chip_style_banco = """
            QRadioButton {
                font-size: 11pt;
                padding: 6px 14px;
                border: 1px solid #cbd5e1;
                border-radius: 14px;
                background: #f1f5f9;
            }
            QRadioButton:hover { background: #e2e8f0; }
            QRadioButton::indicator { width: 0px; height: 0px; }
            QRadioButton:checked {
                background: #3b82f6;
                color: white;
                border: 1px solid #1d4ed8;
                font-weight: bold;
            }
        """

        for texto in ["Caja", "Federal Bank", "SBI", "Union Bank", "Otro"]:
            rb = QRadioButton(texto)
            rb.setStyleSheet(chip_style_banco)
            self.banco_buttons.addButton(rb)
            banco_layout.addWidget(rb)
            if texto == "Caja":
                rb.setChecked(True)

        fila_banco_estado.addLayout(banco_layout)

        # Grupo Estado
        self.estado_buttons = QButtonGroup(self)
        self.estado_buttons.setExclusive(True)
        estado_layout = QHBoxLayout()
        estado_layout.setSpacing(8)

        chip_style_estado = """
            QRadioButton {
                font-size: 11pt;
                padding: 6px 14px;
                border: 1px solid #cbd5e1;
                border-radius: 14px;
                background: #f1f5f9;
            }
            QRadioButton:hover { background: #e2e8f0; }
            QRadioButton::indicator { width: 0px; height: 0px; }
            QRadioButton:checked {
                background: #10b981;
                color: white;
                border: 1px solid #059669;
                font-weight: bold;
            }
        """

        for texto in ["Pagado", "Pendiente"]:
            rb = QRadioButton(texto)
            rb.setStyleSheet(chip_style_estado)
            self.estado_buttons.addButton(rb)
            estado_layout.addWidget(rb)
            if texto == "Pagado":
                rb.setChecked(True)

        fila_banco_estado.addLayout(estado_layout)
        fila_banco_estado.addStretch()

        form_layout.addRow("Banco / Estado:", fila_banco_estado)

        layout.addWidget(form)

        # BOTONES PRINCIPALES (más compactos)
        btns = QHBoxLayout()
        btns.setSpacing(12)

        self.btn_refresh = QPushButton("Actualizar lista")
        self.btn_refresh.setObjectName("refresh")
        self.btn_refresh.clicked.connect(self._cargar_ultimos)

        self.btn_duplicar = QPushButton("Duplicar movimiento")
        self.btn_duplicar.setObjectName("duplicar")
        self.btn_duplicar.clicked.connect(self._duplicar)

        self.btn_guardar = QPushButton("Guardar Movimiento")
        self.btn_guardar.setObjectName("guardar")
        self.btn_guardar.clicked.connect(self._guardar)

        self.btn_limpiar = QPushButton("Limpiar Formulario")
        self.btn_limpiar.setObjectName("limpiar")
        self.btn_limpiar.clicked.connect(self._limpiar)

        self.btn_limpiar_dh = QPushButton("Limpiar Debe/Haber")
        self.btn_limpiar_dh.setObjectName("limpiar_dh")
        self.btn_limpiar_dh.clicked.connect(self._limpiar_dh)

        self.btn_nuevo = QPushButton("Nuevo Registro")
        self.btn_nuevo.setObjectName("nuevo")
        self.btn_nuevo.clicked.connect(self._nuevo_registro)

        for b in [self.btn_refresh, self.btn_duplicar, self.btn_guardar, self.btn_limpiar, self.btn_limpiar_dh, self.btn_nuevo]:
            btns.addWidget(b)

        layout.addLayout(btns)

        # Buscador
        self.buscador = QLineEdit()
        self.buscador.setPlaceholderText("Buscar en movimientos…")
        self.buscador.textChanged.connect(self._filtrar_tabla)
        layout.addWidget(self.buscador)

        # Tabla
        self.tabla = QTableWidget(0, 10)
        self.tabla.setHorizontalHeaderLabels([
            "Fecha", "Documento", "Concepto", "Cuenta", "Nombre Cuenta",
            "Debe", "Haber", "Banco", "Estado", "Saldo"
        ])
        self.tabla.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.tabla.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.tabla.setEditTriggers(QAbstractItemView.NoEditTriggers)
        layout.addWidget(self.tabla)

        # Totales
        self.lbl_totales = QLabel()
        self.lbl_totales.setAlignment(Qt.AlignCenter)
        self.lbl_totales.setStyleSheet("font-weight:bold;font-size:15px;padding:10px;background:#e0e7ff;border-radius:8px;")
        layout.addWidget(self.lbl_totales)

    # ============================================================
    # LÓGICA ORIGINAL (100% INTACTA)
    # ============================================================

    def _on_cuenta_changed(self, texto):
        if " – " not in texto:
            self.lbl_nombre.setText("Seleccione una cuenta")
            self.lbl_sugerencias.setText("")
            return

        codigo = texto.split(" – ")[0]
        self.lbl_nombre.setText("→ " + self.motor.get_nombre(codigo))

        regla = self.motor.reglas.get(codigo, {})
        sugeridos = regla.get("permitidos", [])
        if sugeridos:
            self.lbl_sugerencias.setText("Ejemplos: " + ", ".join(sugeridos[:5]))
        else:
            self.lbl_sugerencias.setText("No hay sugerencias")

    def _validar_concepto_live(self):
        concepto = self.concepto.text().lower()
        cuenta_txt = self.cuenta_combo.currentText()
        if " – " not in cuenta_txt:
            return
        codigo = cuenta_txt.split(" – ")[0]

        if self.motor.es_concepto_valido(codigo, concepto):
            self.concepto.setStyleSheet("border:2px solid #22c55e;background:#f0fdf4;")
        else:
            self.concepto.setStyleSheet("border:2px solid #facc15;background:#fffbeb;")

    def _calcular_importe(self):
        debe = self._normalizar_numero(self.debe.text())
        haber = self._normalizar_numero(self.haber.text())
        if debe > 0:
            self.haber.setText("0,00")
        elif haber > 0:
            self.debe.setText("0,00")

    def _normalizar_numero(self, txt):
        if not txt:
            return 0.0
        txt = txt.replace(".", "").replace(",", ".")
        try:
            return float(txt)
        except:
            return 0.0

    def _formatear_numero(self, v):
        return f"{v:,.2f}".replace(",", "X").replace(".", ",").replace("X", ".")

    def _guardar(self):
        documento = self.documento.text().strip() or f"SIN-DOC-{random.randint(10000,99999)}"

        if any(m.get("documento","") == documento for m in self.data.movimientos):
            QMessageBox.critical(self, "Error", "Documento duplicado.")
            return

        if not self.concepto.text().strip() or " – " not in self.cuenta_combo.currentText():
            QMessageBox.warning(self, "Faltan datos", "Complete concepto y cuenta.")
            return

        debe = self._normalizar_numero(self.debe.text())
        haber = self._normalizar_numero(self.haber.text())

        if debe == 0 and haber == 0:
            QMessageBox.warning(self, "Error", "Debe ingresar Debe o Haber.")
            return
        if debe > 0 and haber > 0:
            QMessageBox.warning(self, "Error", "Debe y Haber no pueden coexistir.")
            return

        codigo = self.cuenta_combo.currentText().split(" – ")[0]
        concepto = self.concepto.text().strip()

        if not self.motor.es_concepto_valido(codigo, concepto):
            r = QMessageBox.question(
                self, "Validación", 
                "El concepto no coincide con las reglas típicas.\n¿Desea guardarlo igual?",
                QMessageBox.Yes | QMessageBox.No
            )
            if r != QMessageBox.Yes:
                return

        # Banco
        banco = next((b.text() for b in self.banco_buttons.buttons() if b.isChecked()), "Caja")

        # Estado
        estado = "pagado" if any(b.text() == "Pagado" and b.isChecked() for b in self.estado_buttons.buttons()) else "pendiente"

        self.data.agregar_movimiento(
            fecha=self.fecha.date().toString("dd/MM/yyyy"),
            documento=documento,
            concepto=concepto,
            cuenta=codigo,
            debe=debe,
            haber=haber,
            moneda="INR",
            banco=banco,
            estado=estado
        )

        self._limpiar()
        self._cargar_ultimos()
        QMessageBox.information(self, "Éxito", "Movimiento guardado correctamente.")

    def _duplicar(self):
        row = self.tabla.currentRow()
        if row < 0:
            QMessageBox.information(self, "Duplicar", "Seleccione un movimiento.")
            return

        m = self.movimientos_filtrados[row]

        self.fecha.setDate(QDate.fromString(m["fecha"], "dd/MM/yyyy"))
        self.documento.clear()
        self.concepto.setText(m["concepto"])

        cuenta = m["cuenta"]
        self.cuenta_combo.setCurrentText(f"{cuenta} – {self.data.obtener_nombre_cuenta(cuenta)}")

        self.debe.setText(self._formatear_numero(float(m["debe"])))
        self.haber.setText(self._formatear_numero(float(m["haber"])))

        # Banco
        banco_val = m.get("banco", "Caja")
        for rb in self.banco_buttons.buttons():
            if rb.text() == banco_val:
                rb.setChecked(True)

        # Estado
        estado = m.get("estado", "pagado")
        for rb in self.estado_buttons.buttons():
            if rb.text().lower() == estado:
                rb.setChecked(True)

    def _limpiar(self):
        self.fecha.setDate(QDate.currentDate())
        self.documento.clear()
        self.concepto.clear()
        self.debe.setText("0,00")
        self.haber.setText("0,00")
        self.cuenta_combo.setCurrentIndex(-1)
        self.lbl_nombre.setText("Seleccione una cuenta")
        self.lbl_sugerencias.setText("")

    def _limpiar_dh(self):
        self.debe.setText("0,00")
        self.haber.setText("0,00")

    def _nuevo_registro(self):
        self._limpiar()

    def _cargar_ultimos(self):
        movs = sorted(
            self.data.movimientos,
            key=lambda m: datetime.strptime(m["fecha"], "%d/%m/%Y"),
            reverse=True
        )[:20]

        self.movimientos_filtrados = movs
        self.tabla.setRowCount(0)

        total_debe = 0
        total_haber = 0
        saldo = 0

        for m in movs:
            debe = float(m["debe"])
            haber = float(m["haber"])
            saldo += haber - debe

            total_debe += debe
            total_haber += haber

            row = self.tabla.rowCount()
            self.tabla.insertRow(row)

            datos = [
                m["fecha"],
                m["documento"],
                m["concepto"],
                m["cuenta"],
                self.data.obtener_nombre_cuenta(m["cuenta"]),
                self._formatear_numero(debe),
                self._formatear_numero(haber),
                m["banco"],
                m["estado"],
                self._formatear_numero(saldo),
            ]

            for col, val in enumerate(datos):
                it = QTableWidgetItem(str(val))
                if col in (5,6,9):
                    it.setTextAlignment(Qt.AlignRight)
                self.tabla.setItem(row, col, it)

        self.lbl_totales.setText(
            f"TOTAL DEBE: {self._formatear_numero(total_debe)}  |  "
            f"TOTAL HABER: {self._formatear_numero(total_haber)}  |  "
            f"SALDO: {self._formatear_numero(total_haber-total_debe)}"
        )

    def _filtrar_tabla(self):
        texto = self.buscador.text().lower()
        for row in range(self.tabla.rowCount()):
            mostrar = any(
                texto in (self.tabla.item(row,col).text().lower() 
                          if self.tabla.item(row,col) else "")
                for col in range(10)
            )
            self.tabla.setRowHidden(row, not mostrar)